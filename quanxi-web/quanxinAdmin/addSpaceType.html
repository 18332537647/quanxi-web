<!DOCTYPE html>
<html lang="zh">

	<head>
		<meta charset="UTF-8" />
		<meta name="viewport" content="width=device-width, initial-scale=1.0" />
		<meta http-equiv="X-UA-Compatible" content="ie=edge" />
		<title>添加空间分类</title>

		<link rel="stylesheet" href="../css/plugins/layui/css/layui.css">
		<link href="../css/font-awesome.min.css?v=4.4.0" rel="stylesheet">
		<link rel="stylesheet" href="../css/plugins/bootstrap/bootstrap.min.css">
		<link rel="stylesheet" href="../css/plugins/tree/jquery.treegrid.css">
		<link rel="stylesheet" href="../css/plugins/tree/treeGridStyles.css" />
		<link rel="stylesheet" href="../css/plugins/metroStyle/metroStyle.css" />
		<link rel="stylesheet" href="../css/plugins/zTreeStyle/zTreeStyle.css" />
		<script src="http://www.jq22.com/jquery/jquery-2.1.1.js"></script>

	</head>
	<style>
		#ggBox {
			background-color: #fff;
			padding: 0 30px 30px 30px;
		}
		
		.formHeader {
			margin: 20px 0 10px 0;
		}
		
		body {
			margin: 20px;
		}
		
		thead tr {
			font-weight: bold;
			background-color: #eee;
		}
		
		.layui-form-label {
			width: 130px;
		}
		
		.layui-input,
		.layui-textarea {
			width: 90%;
		}
		
		.layui-upload {
			border: 1px solid #eee;
			width: 96px;
			height: 96px;
			float: left;
			text-align: center;
		}
		
		.layui-upload-list {
			margin-top: -95px;
		}
		
		.layui-form select {
			display: block
		}
		
		.btn {
			margin-right: 10px;
		}
		
		#treeDemo {
			position: absolute;
			z-index: 9;
			width: 300px;
			height: 200px;
			border: 1px solid #eee;
			padding-left: 20px;
			background-color: #eee;
		}
	</style>

	<body>
		<div class="form-inline formHeader">
			<div class="form-group">
				<input type="text" class="form-control" id="serchId" placeholder="请输入id进行搜索">
			</div>
			<button type="submit" class="btn btn-default">查找</button>
			<button type="button" class="btn btn-primary" data-toggle="modal" data-target="#myModal" style="float:right;">添加</button>
		</div>
		<table class="tree table table-hover table-bordered" style="text-align: center;">
			<thead>
				<tr>
					<td>名称</td>
					<td>描述</td>
					<td>创建时间</td>
					<td>操作</td>
				</tr>
			</thead>
			<tbody>
			</tbody>
		</table>
		<!-- 添加规格型号的弹窗 -->
		<div class="modal fade" id="myModal" tabindex="-1" role="dialog" aria-labelledby="myModalLabel">
			<div class="modal-dialog" role="document" style="width:80%;">
				<div class="modal-content">
					<div class="modal-header">
						<button type="button" class="close" data-dismiss="modal" aria-label="Close"><span aria-hidden="true">&times;</span></button>
						<h4 class="modal-title" id="myModalLabel">添加空间类型</h4>
					</div>
					<div class="modal-body">
						<div id="ggBox">
							<form class="layui-form" action="" id="myform" enctype="multipart/form-data">
								<div class="layui-form-item">
									<div class="layui-inline">
										<label class="layui-form-label">名称：</label>
										<div class="layui-input-inline">
											<input type="text" name="name" autocomplete="off" class="layui-input" placeholder="请输入空间名称">
										</div>
									</div>
								</div>
								<div class="layui-form-item">
									<div class="layui-inline">
										<label class="layui-form-label">排序：</label>
										<div class="layui-input-inline">
											<input type="text" name="sort" autocomplete="off" class="layui-input" placeholder="请进行排序">
										</div>
									</div>
								</div>
								<div class="layui-form-item">
									<label class="layui-form-label">选择父级空间</label>
									<div class="layui-input-inline">
										<input type="text" id="parentId" class="layui-input" onclick="selSpaceType()" name="parentId" />
										<div id="treeDemo" class="ztree"></div>
									</div>
								</div>
								<div class="layui-form-item">
									<label class="layui-form-label">说明描述：</label>
									<div class="layui-input-block">
										<input type="text" name="description" lay-verify="title" autocomplete="off" placeholder="请添加说明描述" class="layui-input">
									</div>
								</div>

								<div class="layui-form-item">
									<label class="layui-form-label">上传空间图片：</label>
									<div class="layui-upload">
										<!--<button type="button" class="" id="test1">上传图片</button>-->
										<span id="test1">上传图片</span>
										<div class="layui-upload-list">
											<!--<img class="layui-upload-img" id="demo1">-->
											<!--<input type="file" name="ImgFile" v-model="ImgFile" />-->
											<p id="demoText"></p>
										</div>
									</div>
								</div>
							</form>
						</div>
					</div>
					<div class="modal-footer">
						<button type="button" class="btn btn-default" data-dismiss="modal">关闭</button>
						<button type="button" class="btn btn-primary" onclick="postData()" data-dismiss="modal">保存</button>
					</div>
				</div>
			</div>
		</div>

	</body>
	<script src="../js/CONSTANT.js"></script>
	<script src="../js/plugins/layui/layui.js "></script>
	<script src="../js/plugins/vue/vue.js "></script>
	<script src="../js/plugins/bootstrap/bootstrap.min.js"></script>
	<script src="../js/plugins/tree/jquery.treegrid.min.js"></script>
	<script src="../js/plugins/tree/jquery.treegrid.bootstrap3.js"></script>
	<script src="../js/plugins/tree/jquery.ztree.core.min.js"></script>
	<script>
		var zTreeData = {};
		var zTreeObj;
		var setting = {
			view: {
				selectedMulti: true, //设置是否能够同时选中多个节点
				showIcon: true, //设置是否显示节点图标
				showLine: true, //设置是否显示节点与节点之间的连线
				showTitle: true, //设置是否显示节点的title提示信息
			},
			data: {
				simpleData: {
					enable: false, //设置是否启用简单数据格式（zTree支持标准数据格式跟简单数据格式，上面例子中是标准数据格式）
					idKey: "id", //设置启用简单数据格式时id对应的属性名称
					pidKey: "pId" //设置启用简单数据格式时parentId对应的属性名称,ztree根据id及pid层级关系构建树结构
				}
			},
			check: {
				enable: true //设置是否显示checkbox复选框
			},
			callback: {
				onClick: onClick, //定义节点单击事件回调函数
				/*onRightClick: OnRightClick, //定义节点右键单击事件回调函数
				beforeRename: beforeRename, //定义节点重新编辑成功前回调函数，一般用于节点编辑时判断输入的节点名称是否合法
				onDblClick: onDblClick, //定义节点双击事件回调函数
				onCheck: onCheck //定义节点复选框选中或取消选中事件的回调函数*/
			},
			async: {
				enable: true, //设置启用异步加载
				type: "get", //异步加载类型:post和get
				contentType: "application/json", //定义ajax提交参数的参数类型，一般为json格式
				url: "_URL_BASE + '/industrySpace/getAllTree", //定义数据请求路径
				autoParam: ["id=id", "name=name"] //定义提交时参数的名称，=号前面标识节点属性，后面标识提交时json数据中参数的名称
			}
		};

		function onClick(e, treeId, treeNode) {
			var zTree = $.fn.zTree.getZTreeObj("treeDemo"),
			nodes = zTree.getSelectedNodes(),
			v = "";
			nodes.sort(function compare(a,b){return a.id-b.id;});
			for (var i=0, l=nodes.length; i<l; i++) {
				v += nodes[i].name + ",";
			}
			if (v.length > 0 ) v = v.substring(0, v.length-1);
			var spaceObj = $("#parentId");
			spaceObj.attr("value", v);
		}

		//获取列表数据
		function getIndustrySpaceData() {
			var data;
			$.ajax({　　　　　　　
				url: _URL_BASE + '/industrySpace/getAllTree',
				data: data,
				type: 'get',
				success: function(retData) { //成功回调函数
					console.log(retData);　　　　　　
					var dataList = retData.DataList;
					zTreeData = retData.DataTree.children;
					console.log(zTreeData);
					var str = "";
					for(i in dataList) {
						var getTime = new Date(dataList[i].createTime);
						Date.prototype.toLocaleString = function() {
							var date = new Date(getTime); //时间戳为10位需*1000，时间戳为13位的话不需乘1000
							Y = date.getFullYear() + '-';
							M = (date.getMonth() + 1 < 10 ? '0' + (date.getMonth() + 1) : date.getMonth() + 1) + '-';
							D = date.getDate() < 10 ? '0' + date.getDate() : date.getDate() + ' ';
							return Y + M + D;
						};
						formatTime = getTime.toLocaleString();
						str += "<tr class='treegrid-" + (dataList[i].level + 1) + (dataList[i].level == 0 ? "" : " treegrid-parent-" + (dataList[i].level)) + "'><td>" + dataList[i].name + "</td><td>" + dataList[i].desc + "</td><td>" + formatTime + "</td>" + "<td><button type='button' class='btn btn-primary btn-xs'>" + "编辑" + "</button><button type='button' class='btn btn-danger btn-xs del' onclick=delIndustrySpace('" + dataList[i].id + "')>" + "删除" + "</button>" + "</td></tr>";
					}
					$("tbody").append(str);
					$('.tree').treegrid();
				},
				error: function(err) { //失败回调函数
					alert("获取数据失败");　　　　　　　
				}　　　　　　
			});
		}
		//提交新增数据
		function addIndustrySpace() {
			var data = $("#myform").serialize();
			console.log(data);
			$.ajax({
				type: 'post',
				url: _URL_BASE + '/industrySpace/addIndustrySpace',
				data: data,
				cache: false,
				dataType: 'json',
				success: function(retData) {
					getIndustrySpaceData();
				},
				error: function(retData) {
					alert("error");
				}
			});
		}
		//删除列表
		function delIndustrySpace(id) {
			var data = {};
			data.id = id;
			alert(id);
			$.ajax({　　　　　　　
				url: _URL_BASE + '/industrySpace/deleteIndustrySpace?id="+data.id+"',
				　　data: data,
				　　type: 'post',
				　　success: function(data) { //成功回调函数
					console.log(data);
				},
				　　error: function(err) { //失败回调函数
					alert("删除失败");　　　　　　　
				}　　　　　　
			});
		}

		function selSpaceType() {
			console.log(zTreeData);
			zTreeObj = $.fn.zTree.init($("#treeDemo"), setting, zTreeData);

		}
		$(function() {
			getIndustrySpaceData();

			$('#serchId').on('change', function() {
				$('table tbody tr').hide()
					.filter(":contains('" + ($('#serchId').val()) + "')")
					.show();
			})
		});
	</script>

</html>